<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>哨笛简谱工坊 (Tin Whistle Tab Maker)</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      @page { margin: 1cm; }
      body { -webkit-print-color-adjust: exact; background: white; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // Lucide React Icons as inline SVG components
    const Printer = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
      </svg>
    );

    const Music = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
      </svg>
    );

    const Info = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const Eraser = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );

    const FileText = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
    );

    const Settings = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );

    const WhistleTabMaker = () => {
      // Default song: Down by the Salley Gardens (Fragment)
      const defaultText = `1 2 3 5/ 6/ | 1+ 6 5 - |
3 1 2 3/ 5/ | 6 5 - - |
1+ 6 5 3 | 1 2 3/ 5/ | 6 5 - - |`;

      const [input, setInput] = useState(defaultText);
      const [fontSize, setFontSize] = useState('medium');
      const [selectedKey, setSelectedKey] = useState('D'); // D, G, A, C, etc.
  
  // D Major Whistle Fingering Map 
  // 1 = Closed, 0 = Open, 0.5 = Half Hole
  // Format: [Top Hole (Hole 6), ..., Bottom Hole (Hole 1)]
  // Standard scale: D(1), E(2), F#(3), G(4), A(5), B(6), C#(7)
  const baseFingerings = {
    // --- Low Octave ---
    'L1':  [1, 1, 1, 1, 1, 1], // D
    'L1#': [1, 1, 1, 1, 1, 0.5], // D# / Eb (Half hole)
    'L2':  [1, 1, 1, 1, 1, 0], // E
    'L2#': [1, 1, 0, 1, 1, 0], // F Natural (Cross fingering) or [1,1,1,1,0.5,0]
    'L3':  [1, 1, 1, 1, 0, 0], // F#
    'L4':  [1, 1, 1, 0, 0, 0], // G
    'L4#': [1, 1, 1, 0.5, 0, 0], // G# (Half hole)
    'L5':  [1, 1, 0, 0, 0, 0], // A
    'L5#': [1, 0, 1, 0, 0, 0], // Bb (Cross fingering OXXOOO is C-nat, XOXOOO is Bb usually) - Using XOX OOO for Bb
    'L6':  [1, 0, 0, 0, 0, 0], // B
    'L7b': [0, 1, 1, 0, 0, 0], // C Natural (OXX OOO)
    'L7':  [0, 0, 0, 0, 0, 0], // C#

    // --- Middle Octave (Standard Range 1) ---
    '1':   [1, 1, 1, 1, 1, 1], // D
    '1#':  [1, 1, 1, 1, 1, 0.5], // D#
    '2':   [1, 1, 1, 1, 1, 0], // E
    '2#':  [1, 1, 0, 1, 1, 0], // F Natural (Cross)
    '3':   [1, 1, 1, 1, 0, 0], // F#
    '4':   [1, 1, 1, 0, 0, 0], // G
    '4#':  [1, 1, 1, 0.5, 0, 0], // G#
    '5':   [1, 1, 0, 0, 0, 0], // A
    '5#':  [1, 0, 1, 0, 0, 0], // Bb (A#)
    '6':   [1, 0, 0, 0, 0, 0], // B
    '7b':  [0, 1, 1, 0, 0, 0], // C Natural
    '7':   [0, 0, 0, 0, 0, 0], // C#

    // --- High Octave (Range 2) ---
    'H1':  [0, 1, 1, 1, 1, 1], // High D
    'H1#': [0, 1, 1, 1, 1, 0.5], // High D#
    'H2':  [1, 1, 1, 1, 1, 0], // High E
    'H2#': [1, 1, 0, 1, 1, 0], // High F Nat
    'H3':  [1, 1, 1, 1, 0, 0], // High F#
    'H4':  [1, 1, 1, 0, 0, 0], // High G
    'H4#': [1, 1, 1, 0.5, 0, 0], // High G#
    'H5':  [1, 1, 0, 0, 0, 0], // High A
    'H5#': [1, 0, 1, 0, 0, 0], // High Bb
    'H6':  [1, 0, 0, 0, 0, 0], // High B
    'H7b': [0, 1, 1, 0, 0, 0], // High C Nat
    'H7':  [0, 0, 0, 0, 0, 0], // High C#
  };

  // Logic to transform notes based on Key Signature
  const getKeyModifiedNote = (noteVal, keySignature) => {
    // Determine the actual note to play based on the key signature relative to D Major
    // D Major (Default): 1=D, 2=E, 3=F#, 4=G, 5=A, 6=B, 7=C#
    
    // G Major: Has C natural instead of C#. (Flatten 7)
    if (keySignature === 'G' && noteVal === '7') return '7b';

    // A Major: Has G# instead of G. (Sharp 4)
    if (keySignature === 'A' && noteVal === '4') return '4#';

    // C Major: Has F natural (Flatten 3) and C natural (Flatten 7)
    if (keySignature === 'C') {
        if (noteVal === '3') return '2#'; // F Natural (usually called flat 3 or sharp 2)
        if (noteVal === '7') return '7b';
    }
    
    // F Major (less common on D whistle, but possible): Bb (Flat 6), F nat (Flat 3), C nat (Flat 7)
    if (keySignature === 'F') {
        if (noteVal === '3') return '2#';
        if (noteVal === '6') return '5#';
        if (noteVal === '7') return '7b';
    }

    return noteVal;
  };

  // Parser Logic
  const parseNotes = (text) => {
    const lines = text.split('\n');
    return lines.map((line) => {
      const tokens = line.trim().split(/\s+/);
      return tokens.map(token => {
        if (!token) return null;
        
        let note = null;
        let octave = 'middle';
        let accidental = null; // '#', 'b'
        let isRest = false;
        let isSustain = false;
        let duration = 0; // Number of slashes for rhythm notation
        
        const cleanToken = token.trim();
        
        if (cleanToken === '0') return { type: 'rest' };
        if (cleanToken === '-' || cleanToken === '~') return { type: 'sustain' };
        if (cleanToken === '|') return { type: 'barline' };

        // Enhanced Regex: (accidental)(note)(accidental)(modifiers)(slashes)
        // Matches: 1, 1+, 1#, #1, 7b, b7, 5/, 5//, 5///
        const match = cleanToken.match(/^([#b]?)?([1-7])([#b]?)?([+'_]*)?(\/{0,3})?$/);
        
        if (match) {
          const preAcc = match[1];
          const val = match[2];
          const postAcc = match[3];
          const mods = match[4] || '';
          const slashes = match[5] || '';
          
          note = val;
          accidental = preAcc || postAcc || null;
          duration = slashes.length; // 0=quarter note, 1=eighth, 2=sixteenth, 3=thirty-second
          
          if (mods.includes('+') || mods.includes("'")) octave = 'high';
          else if (mods.includes('_')) octave = 'low';
          
          return { type: 'note', val: note, octave, accidental, duration, original: token };
        }
        
        return { type: 'text', content: token };
      }).filter(Boolean);
    });
  };

  const parsedLines = parseNotes(input);

  const getFingering = (token) => {
    let noteVal = token.val;
    let acc = token.accidental;

    // 1. Apply Key Signature transformations (only if no explicit accidental is given)
    if (!acc) {
        noteVal = getKeyModifiedNote(noteVal, selectedKey);
    } else {
        // Normalize explicit accidentals
        if (acc === '#') noteVal = noteVal + '#';
        if (acc === 'b') {
            // Convert flat to previous sharp for simplicity in map lookup, or dedicated flat entry
            // Simple mapping for this map:
            if (noteVal === '7') noteVal = '7b';
            else if (noteVal === '3') noteVal = '2#'; // Eb/D#? No 3b is F natural? No. 
            // In D Major context: 
            // 3 is F#. 3b is F natural. F natural is mapped as '2#' or special entry.
            else if (noteVal === '2') noteVal = '1#'; // Eb
            else noteVal = noteVal + '#'; // Fallback
        }
    }

    // 2. Build Lookup Key
    let key = noteVal;
    if (token.octave === 'high') key = 'H' + noteVal;
    else if (token.octave === 'low') key = 'L' + noteVal;
    
    return baseFingerings[key] || baseFingerings[noteVal] || [0,0,0,0,0,0];
  };

  const handlePrint = () => window.print();

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800">
      <header className="bg-emerald-700 text-white p-4 shadow-md print:hidden">
        <div className="max-w-5xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Music className="w-6 h-6" />
            <h1 className="text-xl font-bold">哨笛简谱工坊 (Tin Whistle Tab Maker)</h1>
          </div>
          <button 
            onClick={handlePrint}
            className="flex items-center gap-2 bg-white text-emerald-800 px-4 py-2 rounded-lg hover:bg-emerald-50 transition font-medium shadow-sm"
          >
            <Printer className="w-4 h-4" />
            打印/保存PDF
          </button>
        </div>
      </header>

      <div className="flex-1 flex flex-col md:flex-row max-w-7xl mx-auto w-full p-4 gap-6">
        
        {/* Editor Panel */}
        <div className="w-full md:w-1/3 flex flex-col gap-4 print:hidden">
          
          <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col">
            <div className="flex justify-between items-center mb-2">
              <h2 className="font-semibold text-slate-700 flex items-center gap-2">
                <FileText className="w-4 h-4" />
                简谱输入
              </h2>
              <button 
                onClick={() => setInput('')}
                className="text-xs text-slate-500 hover:text-red-500 flex items-center gap-1"
              >
                <Eraser className="w-3 h-3" /> 清空
              </button>
            </div>
            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              className="w-full flex-1 p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-mono text-lg resize-none outline-none"
              placeholder="在这里输入数字..."
              spellCheck="false"
            />
            
            <div className="mt-4 bg-emerald-50 p-3 rounded-lg text-sm text-emerald-800 border border-emerald-100">
              <div className="font-semibold mb-1 flex items-center gap-1">
                <Info className="w-4 h-4" /> 输入指南:
              </div>
              <ul className="space-y-1 list-disc list-inside opacity-90 text-xs">
                <li><code className="bg-white px-1 border rounded">1-7</code> : 中音 (例如: 1)</li>
                <li><code className="bg-white px-1 border rounded">+</code> : 高音 (例如: 1+)</li>
                <li><code className="bg-white px-1 border rounded">#</code> / <code className="bg-white px-1 border rounded">b</code> : 升降 (例如: 4# 或 7b)</li>
                <li><code className="bg-white px-1 border rounded">/</code> : 时值 (例如: 5/ 八分, 5// 十六分, 5/// 三十二分)</li>
                <li><code className="bg-white px-1 border rounded">|</code> : 小节分隔符</li>
                <li><code className="bg-white px-1 border rounded">0</code> : 休止符 | <code className="bg-white px-1 border rounded">~</code> : 延音</li>
              </ul>
            </div>
          </div>

          {/* Settings */}
          <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
             <div className="flex items-center gap-2 mb-3">
                <Settings className="w-4 h-4 text-slate-500" />
                <h2 className="font-semibold text-slate-700">选项设置</h2>
             </div>
             
             <div className="space-y-4">
                <div>
                    <label className="text-sm text-slate-500 block mb-1">指法调式 (D调哨笛)</label>
                    <div className="grid grid-cols-2 gap-2">
                        {[
                            { id: 'D', label: 'D调 (标准)' },
                            { id: 'G', label: 'G调 (还原C)' },
                            { id: 'A', label: 'A调 (升G)' },
                            { id: 'C', label: 'C调 (还原F,C)' },
                        ].map(key => (
                            <button
                                key={key.id}
                                onClick={() => setSelectedKey(key.id)}
                                className={`py-1.5 px-3 rounded-md text-sm border text-left transition-colors ${
                                selectedKey === key.id
                                ? 'bg-emerald-600 text-white border-emerald-600 ring-2 ring-emerald-100' 
                                : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'
                                }`}
                            >
                                <span className="font-medium">{key.id}</span> <span className="text-xs opacity-80">{key.label.replace(key.id, '')}</span>
                            </button>
                        ))}
                    </div>
                </div>

                <div>
                    <label className="text-sm text-slate-500 block mb-1">显示大小</label>
                    <div className="flex gap-2">
                        {['small', 'medium', 'large'].map(size => (
                        <button
                            key={size}
                            onClick={() => setFontSize(size)}
                            className={`flex-1 py-1 rounded border text-sm capitalize ${
                            fontSize === size 
                            ? 'bg-emerald-600 text-white border-emerald-600' 
                            : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'
                            }`}
                        >
                            {size}
                        </button>
                        ))}
                    </div>
                </div>
             </div>
          </div>
        </div>

        {/* Preview Panel */}
        <div className="w-full md:w-2/3 bg-white shadow-lg rounded-xl overflow-hidden print:shadow-none print:w-full print:absolute print:top-0 print:left-0">
          <div className="p-8 min-h-[800px] print:min-h-0">
            <div className="text-center mb-8 border-b border-slate-200 pb-4">
               <h1 className="text-3xl font-serif text-slate-800 mb-2">哨笛演奏谱</h1>
               <div className="flex justify-center gap-4 text-sm text-slate-400">
                    <span>Key: {selectedKey} Major</span>
                    <span>Whistle: High D</span>
               </div>
            </div>

            <div className={`space-y-6 ${
                fontSize === 'small' ? 'text-base' : 
                fontSize === 'large' ? 'text-2xl' : 'text-xl'
              }`}>
              {parsedLines.map((line, lineIdx) => (
                <div key={lineIdx} className="flex flex-wrap items-end gap-x-2 gap-y-8 mb-6 leading-none">
                  {line.map((token, tokenIdx) => {
                    
                    if (token.type === 'note') {
                      const holes = getFingering(token);
                      return (
                        <div key={tokenIdx} className="flex flex-col items-center group relative min-w-[2em]">
                          {/* Jianpu Number */}
                          <div className="font-bold font-serif mb-4 relative pb-2">
                            {token.octave === 'high' && (
                              <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-slate-800"></div>
                            )}
                            
                            {/* Accidental Display */}
                            <span className="text-slate-800 relative inline-block">
                                {token.accidental && (
                                    <span className="absolute -left-3 top-0 text-xs scale-75 font-normal opacity-80">
                                        {token.accidental}
                                    </span>
                                )}
                                {token.val}
                                {/* Duration underlines */}
                                {token.duration > 0 && (
                                  <span className="absolute -bottom-2 left-0 right-0 flex flex-col gap-[2px]">
                                    {[...Array(token.duration)].map((_, idx) => (
                                      <span key={idx} className="block h-[2px] bg-slate-800"></span>
                                    ))}
                                  </span>
                                )}
                            </span>
                            
                            {token.octave === 'low' && (
                              <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-slate-800"></div>
                            )}
                          </div>

                          {/* Whistle Visual */}
                          <div className="bg-slate-100 rounded-full p-1 border border-slate-200 flex flex-col gap-[2px]">
                            {holes.map((state, hIdx) => (
                              <div 
                                key={hIdx} 
                                className={`
                                  rounded-full border border-slate-800 relative overflow-hidden
                                  ${fontSize === 'small' ? 'w-2 h-2' : fontSize === 'large' ? 'w-4 h-4' : 'w-3 h-3'}
                                  ${state === 1 ? 'bg-slate-800' : 'bg-white'}
                                `}
                              >
                                {state === 0.5 && (
                                    <div className="absolute top-0 left-0 w-full h-1/2 bg-slate-800"></div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    }

                    if (token.type === 'barline') {
                       return (
                        <div key={tokenIdx} className="flex flex-col items-center justify-center min-w-[0.5em] mx-2">
                          <div className={`bg-slate-800 ${fontSize === 'small' ? 'w-[2px] h-16' : fontSize === 'large' ? 'w-[3px] h-24' : 'w-[2.5px] h-20'}`}></div>
                        </div>
                       )
                    }

                    if (token.type === 'rest') {
                       return (
                        <div key={tokenIdx} className="flex flex-col items-center justify-end min-w-[1.5em] pb-1">
                          <span className="font-bold text-slate-800 mb-10">0</span>
                        </div>
                       )
                    }

                    if (token.type === 'sustain') {
                       return (
                        <div key={tokenIdx} className="flex flex-col items-center justify-end min-w-[1em] pb-1">
                          <span className="font-bold text-slate-400 mb-10">—</span>
                        </div>
                       )
                    }

                    return (
                       <div key={tokenIdx} className="flex flex-col items-center justify-end min-w-[1em] pb-1">
                          <span className="text-slate-600 mb-10 text-sm">{token.content}</span>
                        </div>
                    )
                  })}
                </div>
              ))}

              {parsedLines.length === 0 || (parsedLines.length === 1 && parsedLines[0].length === 0) ? (
                 <div className="text-center text-slate-300 italic mt-20">
                    在左侧输入简谱...
                 </div>
              ) : null}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// Render the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<WhistleTabMaker />);
  </script>
</body>
</html>